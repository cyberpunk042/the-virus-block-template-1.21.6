[1mdiff --git a/src/main/java/net/cyberpunk042/infection/VirusWorldState.java b/src/main/java/net/cyberpunk042/infection/VirusWorldState.java[m
[1mindex f6f521d..f63cafa 100644[m
[1m--- a/src/main/java/net/cyberpunk042/infection/VirusWorldState.java[m
[1m+++ b/src/main/java/net/cyberpunk042/infection/VirusWorldState.java[m
[36m@@ -1,5 +1,6 @@[m
 package net.cyberpunk042.infection;[m
 [m
[32m+[m[32mimport java.util.ArrayDeque;[m
 import java.util.ArrayList;[m
 import java.util.EnumMap;[m
 import java.util.HashMap;[m
[36m@@ -9,11 +10,14 @@[m [mimport java.util.List;[m
 import java.util.Map;[m
 import java.util.Optional;[m
 import java.util.Set;[m
[32m+[m[32mimport java.util.Deque;[m
 import java.util.UUID;[m
 [m
 import com.mojang.serialization.Codec;[m
 import com.mojang.serialization.codecs.RecordCodecBuilder;[m
 [m
[32m+[m[32mimport it.unimi.dsi.fastutil.doubles.DoubleArrayList;[m
[32m+[m[32mimport it.unimi.dsi.fastutil.ints.IntArrayList;[m
 import it.unimi.dsi.fastutil.objects.Object2DoubleMap;[m
 import it.unimi.dsi.fastutil.objects.Object2DoubleOpenHashMap;[m
 import it.unimi.dsi.fastutil.objects.Object2IntMap;[m
[36m@@ -28,26 +32,34 @@[m [mimport net.cyberpunk042.block.corrupted.CorruptedGlassBlock;[m
 import net.cyberpunk042.block.corrupted.CorruptedStoneBlock;[m
 import net.cyberpunk042.block.corrupted.CorruptionStage;[m
 import net.cyberpunk042.block.entity.MatrixCubeBlockEntity;[m
[32m+[m[32mimport net.cyberpunk042.block.entity.SingularityBlockEntity;[m
[32m+[m[32mimport net.cyberpunk042.entity.BlackholePearlEntity;[m
 import net.cyberpunk042.entity.CorruptedTntEntity;[m
 import net.cyberpunk042.entity.FallingMatrixCubeEntity;[m
[32m+[m[32mimport net.cyberpunk042.entity.VirusFuseEntity;[m
 import net.cyberpunk042.infection.mutation.BlockMutationHelper;[m
 import net.cyberpunk042.mixin.GuardianEntityAccessor;[m
 import net.cyberpunk042.network.DifficultySyncPayload;[m
 import net.cyberpunk042.network.VoidTearBurstPayload;[m
[32m+[m[32mimport net.minecraft.block.LightBlock;[m
 import net.cyberpunk042.network.VoidTearSpawnPayload;[m
 import net.cyberpunk042.network.ShieldFieldSpawnPayload;[m
 import net.cyberpunk042.network.ShieldFieldRemovePayload;[m
[32m+[m[32mimport net.cyberpunk042.network.SingularityBorderPayload;[m
 import net.cyberpunk042.registry.ModBlocks;[m
 import net.cyberpunk042.util.VirusEquipmentHelper;[m
 import net.cyberpunk042.util.VirusMobAllyHelper;[m
[32m+[m[32mimport net.fabricmc.fabric.api.networking.v1.ServerPlayNetworking;[m
 import net.minecraft.block.Block;[m
 import net.minecraft.block.Blocks;[m
 import net.minecraft.block.BlockState;[m
[32m+[m[32mimport net.minecraft.block.entity.BlockEntity;[m
 import net.minecraft.datafixer.DataFixTypes;[m
 import net.minecraft.entity.Entity;[m
 import net.minecraft.entity.EntityStatuses;[m
 import net.minecraft.entity.EntityType;[m
 import net.minecraft.entity.FallingBlockEntity;[m
[32m+[m[32mimport net.minecraft.entity.ItemEntity;[m
 import net.minecraft.entity.LivingEntity;[m
 import net.minecraft.entity.SpawnReason;[m
 import net.minecraft.entity.attribute.EntityAttributeInstance;[m
[36m@@ -66,16 +78,18 @@[m [mimport net.minecraft.entity.player.PlayerEntity;[m
 import net.minecraft.entity.projectile.ArrowEntity;[m
 import net.minecraft.item.ItemStack;[m
 import net.minecraft.item.Items;[m
[32m+[m[32mimport net.minecraft.particle.BlockStateParticleEffect;[m
[32m+[m[32mimport net.minecraft.particle.DustColorTransitionParticleEffect;[m
[32m+[m[32mimport net.minecraft.particle.ParticleTypes;[m
 import net.minecraft.registry.tag.BlockTags;[m
 import net.minecraft.server.network.ServerPlayerEntity;[m
 import net.minecraft.server.world.ServerWorld;[m
[31m-import net.fabricmc.fabric.api.networking.v1.ServerPlayNetworking;[m
[31m-import net.minecraft.particle.ParticleTypes;[m
 import net.minecraft.sound.SoundCategory;[m
 import net.minecraft.sound.SoundEvents;[m
 import net.minecraft.text.Text;[m
 import net.minecraft.util.Formatting;[m
 import net.minecraft.util.math.BlockPos;[m
[32m+[m[32mimport net.minecraft.util.math.BlockPos.Mutable;[m
 import net.minecraft.util.math.Box;[m
 import net.minecraft.util.math.ChunkPos;[m
 import net.minecraft.util.math.Direction;[m
[36m@@ -88,6 +102,7 @@[m [mimport net.minecraft.world.PersistentState;[m
 import net.minecraft.world.PersistentStateType;[m
 import net.minecraft.world.World.ExplosionSourceType;[m
 import net.minecraft.world.WorldEvents;[m
[32m+[m[32mimport net.minecraft.world.border.WorldBorder;[m
 import org.jetbrains.annotations.Nullable;[m
 [m
 public class VirusWorldState extends PersistentState {[m
[36m@@ -120,16 +135,16 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 			Codec.LONG.optionalFieldOf("ticksInTier", 0L).forGetter(state -> state.ticksInTier),[m
 			Codec.INT.optionalFieldOf("containmentLevel", 0).forGetter(state -> state.containmentLevel),[m
 			Codec.INT.optionalFieldOf("stateFlags", 0).forGetter(VirusWorldState::encodeFlags),[m
[31m-			Codec.DOUBLE.optionalFieldOf("healthScale", 1.0D).forGetter(state -> state.healthScale),[m
[31m-			Codec.DOUBLE.optionalFieldOf("currentHealth", 0.0D).forGetter(state -> state.currentHealth),[m
[32m+[m			[32mHealthSnapshot.CODEC.optionalFieldOf("health", HealthSnapshot.DEFAULT).forGetter(HealthSnapshot::of),[m
 			Codec.STRING.optionalFieldOf("difficulty", VirusDifficulty.HARD.getId()).forGetter(state -> state.difficulty.getId()),[m
 			Codec.BOOL.optionalFieldOf("difficultyPromptShown", false).forGetter(state -> state.difficultyPromptShown),[m
 			BOOBYTRAP_CODEC.optionalFieldOf("boobytrapDefaults").forGetter(VirusWorldState::getBoobytrapDefaultsRecord),[m
 			SPREAD_CODEC.optionalFieldOf("spreadData").forGetter(state -> state.getSpreadSnapshot()),[m
 			Codec.unboundedMap(VirusEventType.CODEC, Codec.LONG).optionalFieldOf("eventHistory", Map.of()).forGetter(VirusWorldState::getEventHistorySnapshot),[m
 			Codec.LONG.optionalFieldOf("lastMatrixCubeTick", 0L).forGetter(state -> state.lastMatrixCubeTick),[m
[31m-			SHIELD_FIELD_CODEC.listOf().optionalFieldOf("shieldFields", List.of()).forGetter(VirusWorldState::getShieldFieldsSnapshot)[m
[31m-	).apply(instance, (infected, dormant, tierIndex, totalTicks, ticksInTier, containmentLevel, stateFlags, healthScale, currentHealth, difficultyId, difficultyPromptShown, boobytrapDefaults, spreadData, events, lastMatrixCubeTick, shields) -> {[m
[32m+[m			[32mSHIELD_FIELD_CODEC.listOf().optionalFieldOf("shieldFields", List.of()).forGetter(VirusWorldState::getShieldFieldsSnapshot),[m
[32m+[m			[32mSingularitySnapshot.CODEC.optionalFieldOf("singularity").forGetter(VirusWorldState::getSingularitySnapshot)[m
[32m+[m	[32m).apply(instance, (infected, dormant, tierIndex, totalTicks, ticksInTier, containmentLevel, stateFlags, healthSnapshot, difficultyId, difficultyPromptShown, boobytrapDefaults, spreadData, events, lastMatrixCubeTick, shields, singularitySnapshot) -> {[m
 		VirusWorldState state = new VirusWorldState();[m
 		state.infected = infected;[m
 		state.dormant = dormant;[m
[36m@@ -141,8 +156,8 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 		state.terrainCorrupted = (stateFlags & FLAG_TERRAIN) != 0;[m
 		state.shellsCollapsed = (stateFlags & FLAG_SHELLS) != 0;[m
 		state.cleansingActive = (stateFlags & FLAG_CLEANSING) != 0;[m
[31m-		state.healthScale = healthScale;[m
[31m-		state.currentHealth = currentHealth;[m
[32m+[m		[32mstate.healthScale = healthSnapshot.scale();[m
[32m+[m		[32mstate.currentHealth = healthSnapshot.current();[m
 		state.difficulty = VirusDifficulty.fromId(difficultyId);[m
 		state.difficultyPromptShown = difficultyPromptShown;[m
 		boobytrapDefaults.ifPresent(def -> {[m
[36m@@ -160,6 +175,7 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 		shields.forEach(field -> state.activeShields.put(field.id(), field));[m
 		state.shellRebuildPending = false;[m
 		state.tierFiveBarrierActive = false;[m
[32m+[m		[32msingularitySnapshot.ifPresentOrElse(state::applySingularitySnapshot, state::clearSingularityState);[m
 		return state;[m
 	}));[m
 	public static final PersistentStateType<VirusWorldState> TYPE = new PersistentStateType<>(ID, VirusWorldState::new, CODEC, DataFixTypes.LEVEL);[m
[36m@@ -177,7 +193,55 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 	private boolean tierFiveBarrierActive;[m
 	private long nextTierFiveBarrierPushTick;[m
 	private boolean finalVulnerabilityBlastTriggered;[m
[31m-	private final LongSet pillarChunks = new LongOpenHashSet();[m
[32m+[m	[32mprivate SingularityState singularityState = SingularityState.DORMANT;[m
[32m+[m	[32mprivate long singularityTicks;[m
[32m+[m	[32m@Nullable[m
[32m+[m	[32mprivate BlockPos singularityCenter;[m
[32m+[m	[32mprivate boolean singularityShellCollapsed;[m
[32m+[m	[32mprivate int singularityCollapseRadius;[m
[32m+[m	[32mprivate boolean singularityCollapseDescending;[m
[32m+[m	[32mprivate int singularityCollapseTotalChunks;[m
[32m+[m	[32mprivate int singularityCollapseCompletedChunks;[m
[32m+[m	[32mprivate int singularityCollapseBarDelay;[m
[32m+[m	[32mprivate int singularityCollapseCompleteHold;[m
[32m+[m	[32mprivate int singularityCollapseTickCooldown;[m
[32m+[m	[32mprivate int singularityRingTicks;[m
[32m+[m	[32mprivate long singularityFuseElapsed;[m
[32m+[m	[32mprivate int singularityPhaseDelay;[m
[32m+[m	[32mprivate int singularityFusePulseTicker;[m
[32m+[m	[32mprivate boolean singularityBorderActive;[m
[32m+[m	[32mprivate boolean singularityBorderHasSnapshot;[m
[32m+[m	[32mprivate double singularityBorderCenterX;[m
[32m+[m	[32mprivate double singularityBorderCenterZ;[m
[32m+[m	[32mprivate double singularityBorderInitialDiameter;[m
[32m+[m	[32mprivate double singularityBorderTargetDiameter;[m
[32m+[m	[32mprivate double singularityBorderLastDiameter;[m
[32m+[m	[32mprivate long singularityBorderDuration;[m
[32m+[m	[32mprivate long singularityBorderElapsed;[m
[32m+[m	[32mprivate double singularityBorderOriginalCenterX;[m
[32m+[m	[32mprivate double singularityBorderOriginalCenterZ;[m
[32m+[m	[32mprivate double singularityBorderOriginalDiameter;[m
[32m+[m	[32mprivate double singularityBorderOriginalSafeZone;[m
[32m+[m	[32mprivate double singularityBorderOriginalDamagePerBlock;[m
[32m+[m	[32mprivate int singularityBorderOriginalWarningBlocks;[m
[32m+[m	[32mprivate int singularityBorderOriginalWarningTime;[m
[32m+[m	[32mprivate final DoubleArrayList singularityRingThresholds = new DoubleArrayList();[m
[32m+[m	[32mprivate final IntArrayList singularityRingChunkCounts = new IntArrayList();[m
[32m+[m	[32mprivate int singularityRingIndex;[m
[32m+[m	[32mprivate int singularityRingPendingChunks;[m
[32m+[m	[32mprivate double singularityInitialBorderDiameter;[m
[32m+[m	[32mprivate double singularityFinalBorderDiameter;[m
[32m+[m	[32mprivate long singularityTotalRingTicks;[m
[32m+[m	[32mprivate long singularityRingTickAccumulator;[m
[32m+[m	[32mprivate final Deque<Long> singularityChunkQueue = new ArrayDeque<>();[m
[32m+[m	[32mprivate final Map<BlockPos, UUID> activeFuseEntities = new HashMap<>();[m
[32m+[m	[32m@Nullable[m
[32m+[m	[32mprivate UUID blackholePearlId;[m
[32m+[m	[32mprivate static final boolean ENABLE_BLACKHOLE_PEARL = false;[m
[32m+[m	[32mprivate final Set<BlockPos> singularityGlowNodes = new HashSet<>();[m
[32m+[m	[32mprivate final Map<BlockPos, BlockState> fuseClearedBlocks = new HashMap<>();[m
[32m+[m	[32mprivate final Set<BlockPos> suppressedUnregisters = new HashSet<>();[m
[32m+[m[32mprivate final LongSet pillarChunks = new LongOpenHashSet();[m
 	private final List<VoidTearInstance> activeVoidTears = new ArrayList<>();[m
 	private final List<PendingVoidTear> pendingVoidTears = new ArrayList<>();[m
 	private final Map<Long, ShieldField> activeShields = new HashMap<>();[m
[36m@@ -196,8 +260,39 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 	private static final double HELMET_PING_MAX_PARTICLE_DISTANCE = 32.0D;[m
 	private static final int TIER_FIVE_BARRIER_RADIUS = 6;[m
 	private static final int TIER_FIVE_BARRIER_INTERVAL = 15;[m
[31m-	private static final int FINAL_VULNERABILITY_BLAST_RADIUS = 10;[m
[31m-	private static final double FINAL_VULNERABILITY_BLAST_SCALE = 1.6D;[m
[32m+[m	[32mprivate static final int FINAL_VULNERABILITY_BLAST_RADIUS = 3;[m
[32m+[m	[32mprivate static final double FINAL_VULNERABILITY_BLAST_SCALE = 0.6D;[m
[32m+[m	[32mprivate static final long SINGULARITY_WARNING_TICKS = 400L;[m
[32m+[m	[32mprivate static final long SINGULARITY_SHELL_COLLAPSE_TICKS = 20L;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_MAX_RADIUS = 96;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_PARTICLE_DENSITY = 6;[m
[32m+[m	[32mprivate static final int SINGULARITY_RING_DURATION = 200;[m
[32m+[m	[32mprivate static final int SINGULARITY_CORE_CHARGE_TICKS = 80;[m
[32m+[m	[32mprivate static final int SINGULARITY_RING_START_DELAY = 40;[m
[32m+[m	[32mprivate static final int SINGULARITY_RESET_DELAY_TICKS = 160;[m
[32m+[m[32mprivate static final double SINGULARITY_BORDER_MIN_DIAMETER = 24.0D;[m
[32m+[m[32mprivate static final double SINGULARITY_BORDER_FINAL_DIAMETER = 2.0D;[m
[32m+[m[32mprivate static final double SINGULARITY_BORDER_OVERSTEP = 8.0D;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_CHUNKS_PER_STEP = 1;[m
[32m+[m	[32mprivate static final int SINGULARITY_FUSE_PULSE_INTERVAL = 8;[m
[32m+[m	[32mprivate static final int SINGULARITY_RING_COLUMNS_PER_TICK = 6;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_BAR_DELAY_TICKS = 60;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_COMPLETE_HOLD_TICKS = 40;[m
[32m+[m	[32mprivate static final int SINGULARITY_COLLAPSE_TICK_INTERVAL = 20;[m
[32m+[m	[32mprivate static final BlockPos[] SINGULARITY_GLOW_OFFSETS = new BlockPos[]{[m
[32m+[m			[32mnew BlockPos(0, 1, 0),[m
[32m+[m			[32mnew BlockPos(0, -1, 0),[m
[32m+[m			[32mnew BlockPos(1, 0, 0),[m
[32m+[m			[32mnew BlockPos(-1, 0, 0),[m
[32m+[m			[32mnew BlockPos(0, 0, 1),[m
[32m+[m			[32mnew BlockPos(0, 0, -1)[m
[32m+[m	[32m};[m
[32m+[m	[32mprivate static final float BLACKHOLE_PRIMARY_SCALE = 1.2F;[m
[32m+[m	[32mprivate static final float BLACKHOLE_CORE_SCALE = 1.8F;[m
[32m+[m	[32mprivate static final double SINGULARITY_RING_PULL_RADIUS = 24.0D;[m
[32m+[m	[32mprivate static final double SINGULARITY_RING_PULL_STRENGTH = 0.35D;[m
[32m+[m	[32mprivate static final DustColorTransitionParticleEffect SINGULARITY_FUSE_GLOW =[m
[32m+[m			[32mnew DustColorTransitionParticleEffect(0xFFFFFF, 0xFF3333, 1.1F);[m
 	private static final String[] COMPASS_POINTS = new String[]{"N", "NE", "E", "SE", "S", "SW", "W", "NW"};[m
 [m
 	private boolean infected;[m
[36m@@ -344,7 +439,7 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 		ensureHealthInitialized(tier);[m
 		int tierDuration = getTierDuration(tier);[m
 [m
[31m-		if (!apocalypseMode && tierDuration > 0 && ticksInTier >= tierDuration) {[m
[32m+[m		[32mif (!apocalypseMode && tierDuration > 0 && ticksInTier >= tierDuration && singularityState == SingularityState.DORMANT) {[m
 			advanceTier(world);[m
 		}[m
 [m
[36m@@ -353,18 +448,24 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 			markDirty();[m
 		}[m
 [m
[31m-		BlockMutationHelper.mutateAroundSources(world, virusSources, tier, apocalypseMode);[m
[32m+[m		[32mif (!isSingularityActive() && !shouldSkipSpreadThisTick(world)) {[m
[32m+[m			[32mBlockMutationHelper.mutateAroundSources(world, virusSources, tier, apocalypseMode);[m
[32m+[m		[32m}[m
 		reinforceCores(world, tier);[m
 		maybeSpawnMatrixCube(world, tier);[m
 [m
 		applyDifficultyRules(world, tier);[m
 		maybePushTierFiveBarrier(world, tier);[m
[32m+[m		[32mtickSingularity(world);[m
 		runEvents(world, tier);[m
 		boostAmbientSpawns(world, tier);[m
 		pulseHelmetTrackers(world);[m
 	}[m
 [m
 	private void runEvents(ServerWorld world, InfectionTier tier) {[m
[32m+[m		[32mif (singularityState != SingularityState.DORMANT) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
 		boolean tier2Active = TierCookbook.anyEnabled(world, tier, apocalypseMode, TierFeatureGroup.TIER2_EVENT);[m
 		boolean tier3Active = TierCookbook.anyEnabled(world, tier, apocalypseMode, TierFeatureGroup.TIER3_EXTRA);[m
 		if (!tier2Active && !tier3Active) {[m
[36m@@ -393,6 +494,9 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 	}[m
 [m
 	private void boostAmbientSpawns(ServerWorld world, InfectionTier tier) {[m
[32m+[m		[32mif (singularityState != SingularityState.DORMANT) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
 		if (!world.getGameRules().getBoolean(GameRules.DO_MOB_SPAWNING)) {[m
 			return;[m
 		}[m
[36m@@ -459,7 +563,7 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 			if (!world.isChunkLoaded(ChunkPos.toLong(source))) {[m
 				continue;[m
 			}[m
[31m-			pushPlayersFromBlock(world, source, TIER_FIVE_BARRIER_RADIUS, 0.9D, true);[m
[32m+[m			[32mpushPlayersFromBlock(world, source, TIER_FIVE_BARRIER_RADIUS, 0.9D, false);[m
 			pushed = true;[m
 		}[m
 		if (pushed) {[m
[36m@@ -467,6 +571,1166 @@[m [mprivate static final Codec<VirusWorldState> CODEC = RecordCodecBuilder.create(in[m
 		}[m
 	}[m
 [m
[32m+[m	[32mprivate void tickSingularity(ServerWorld world) {[m
[32m+[m		[32mtickSingularityBorder(world);[m
[32m+[m		[32mif (!infected) {[m
[32m+[m			[32mif (singularityState != SingularityState.DORMANT) {[m
[32m+[m				[32mclearFuseEntities(world);[m
[32m+[m				[32mrevertSingularityBlock(world, false);[m
[32m+[m				[32mresetSingularityState(world);[m
[32m+[m				[32mmarkDirty();[m
[32m+[m			[32m}[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mswitch (singularityState) {[m
[32m+[m			[32mcase DORMANT -> {[m
[32m+[m				[32mif (apocalypseMode) {[m
[32m+[m					[32mreturn;[m
[32m+[m				[32m}[m
[32m+[m				[32mlong remaining = getTicksUntilFinalWave();[m
[32m+[m				[32mif (remaining > 0 && remaining <= SINGULARITY_WARNING_TICKS) {[m
[32m+[m					[32msingularityState = SingularityState.FUSING;[m
[32m+[m					[32msingularityTicks = SINGULARITY_WARNING_TICKS;[m
[32m+[m					[32msingularityShellCollapsed = false;[m
[32m+[m					[32msingularityFusePulseTicker = 0;[m
[32m+[m					[32msingularityFuseElapsed = 0;[m
[32m+[m					[32msingularityCollapseTotalChunks = 0;[m
[32m+[m					[32msingularityCollapseCompletedChunks = 0;[m
[32m+[m					[32msingularityCollapseBarDelay = 0;[m
[32m+[m					[32msingularityCollapseCompleteHold = 0;[m
[32m+[m					[32msingularityCenter = representativePos(world, world.getRandom());[m
[32m+[m					[32mbroadcast(world, Text.translatable("message.the-virus-block.singularity_warning").formatted(Formatting.LIGHT_PURPLE));[m
[32m+[m					[32mmarkDirty();[m
[32m+[m				[32m}[m
[32m+[m				[32mmaintainFuseEntities(world);[m
[32m+[m			[32m}[m
[32m+[m			[32mcase FUSING -> {[m
[32m+[m				[32mif (singularityTicks > 0) {[m
[32m+[m					[32msingularityTicks--;[m
[32m+[m					[32msingularityFuseElapsed++;[m
[32m+[m					[32memitFuseEffects(world);[m
[32m+[m					[32mmaintainFuseEntities(world);[m
[32m+[m					[32mif (!singularityShellCollapsed && singularityFuseElapsed >= SINGULARITY_SHELL_COLLAPSE_TICKS) {[m
[32m+[m						[32msingularityShellCollapsed = true;[m
[32m+[m						[32mif (!shellsCollapsed) {[m
[32m+[m							[32mcollapseShells(world);[m
[32m+[m						[32m}[m
[32m+[m					[32m}[m
[32m+[m					[32mif (singularityTicks <= 0) {[m
[32m+[m						[32mdetonateFuseCore(world);[m
[32m+[m						[32msingularityState = SingularityState.COLLAPSE;[m
[32m+[m						[32msingularityCollapseRadius = computeInitialCollapseRadius(world);[m
[32m+[m						[32msingularityCollapseDescending = true;[m
[32m+[m						[32mprepareSingularityChunkQueue(world);[m
[32m+[m						[32msingularityCollapseBarDelay = SINGULARITY_COLLAPSE_BAR_DELAY_TICKS;[m
[32m+[m						[32msingularityCollapseCompleteHold = SINGULARITY_COLLAPSE_COMPLETE_HOLD_TICKS;[m
[32m+[m			[32msingularityCollapseTickCooldown = 0;[m
[32m+[m						[32mdeploySingularityBorder(world);[m
[32m+[m						[32mif (singularityCenter == null) {[m
[32m+[m							[32msingularityCenter = representativePos(world, world.getRandom());[m
[32m+[m							[32mif (singularityCenter == null && !virusSources.isEmpty()) {[m
[32m+[m								[32msingularityCenter = virusSources.iterator().next();[m
[32m+[m							[32m}[m
[32m+[m						[32m}[m
[32m+[m						[32mactivateSingularityBlock(world);[m
[32m+[m						[32mbroadcast(world, Text.translatable("message.the-virus-block.singularity_collapse").formatted(Formatting.DARK_PURPLE));[m
[32m+[m						[32mmarkDirty();[m
[32m+[m					[32m}[m
[32m+[m				[32m}[m
[32m+[m			[32m}[m
[32m+[m			[32mcase COLLAPSE -> processSingularityCollapse(world);[m
[32m+[m			[32mcase CORE -> processSingularityCore(world);[m
[32m+[m			[32mcase RING -> processSingularityRing(world);[m
[32m+[m			[32mcase DISSIPATION -> processSingularityDissipation(world);[m
[32m+[m		[32m}[m
[32m+[m		[32mmaintainBlackholePearl(world);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void emitFuseEffects(ServerWorld world) {[m
[32m+[m		[32mif (virusSources.isEmpty()) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mfloat intensity = 1.0F - (float) singularityTicks / Math.max(1.0F, SINGULARITY_WARNING_TICKS);[m
[32m+[m		[32mint particleCount = MathHelper.clamp(2 + (int) (intensity * 6), 2, 10);[m
[32m+[m		[32mint pulseInterval = Math.max(4, SINGULARITY_FUSE_PULSE_INTERVAL - MathHelper.floor(intensity * 4));[m
[32m+[m		[32msingularityFusePulseTicker++;[m
[32m+[m		[32mboolean pulse = singularityFusePulseTicker >= pulseInterval;[m
[32m+[m		[32mif (pulse) {[m
[32m+[m			[32msingularityFusePulseTicker = 0;[m
[32m+[m		[32m}[m
[32m+[m		[32mfor (BlockPos source : virusSources) {[m
[32m+[m			[32mif (!world.isChunkLoaded(ChunkPos.toLong(source))) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mVec3d fusePos = resolveFusePosition(world, source);[m
[32m+[m			[32mdouble baseX = fusePos.x;[m
[32m+[m			[32mdouble baseY = fusePos.y;[m
[32m+[m			[32mdouble baseZ = fusePos.z;[m
[32m+[m			[32mfor (int i = 0; i < particleCount; i++) {[m
[32m+[m				[32mdouble x = baseX + world.random.nextGaussian() * 0.3D;[m
[32m+[m				[32mdouble y = baseY + world.random.nextGaussian() * 0.3D;[m
[32m+[m				[32mdouble z = baseZ + world.random.nextGaussian() * 0.3D;[m
[32m+[m				[32mworld.spawnParticles(ParticleTypes.ELECTRIC_SPARK, x, y, z, 1, 0.0D, 0.02D, 0.0D, 0.01D);[m
[32m+[m			[32m}[m
[32m+[m			[32mif (pulse) {[m
[32m+[m				[32mworld.spawnParticles(ParticleTypes.FLASH,[m
[32m+[m						[32mbaseX,[m
[32m+[m						[32mbaseY,[m
[32m+[m						[32mbaseZ,[m
[32m+[m						[32m1,[m
[32m+[m						[32m0.0D,[m
[32m+[m						[32m0.0D,[m
[32m+[m						[32m0.0D,[m
[32m+[m						[32m0.0D);[m
[32m+[m				[32mworld.spawnParticles(SINGULARITY_FUSE_GLOW,[m
[32m+[m						[32mbaseX,[m
[32m+[m						[32mbaseY + 0.1D,[m
[32m+[m						[32mbaseZ,[m
[32m+[m						[32m6,[m
[32m+[m						[32m0.25D,[m
[32m+[m						[32m0.2D,[m
[32m+[m						[32m0.25D,[m
[32m+[m						[32m0.0D);[m
[32m+[m				[32mworld.spawnParticles(ParticleTypes.GLOW,[m
[32m+[m						[32mbaseX,[m
[32m+[m						[32mbaseY + 0.2D,[m
[32m+[m						[32mbaseZ,[m
[32m+[m						[32m4,[m
[32m+[m						[32m0.2D,[m
[32m+[m						[32m0.2D,[m
[32m+[m						[32m0.2D,[m
[32m+[m						[32m0.0D);[m
[32m+[m				[32mworld.playSound(null,[m
[32m+[m						[32mbaseX,[m
[32m+[m						[32mbaseY,[m
[32m+[m						[32mbaseZ,[m
[32m+[m						[32mSoundEvents.ENTITY_TNT_PRIMED,[m
[32m+[m						[32mSoundCategory.BLOCKS,[m
[32m+[m						[32m0.8F + intensity * 0.4F,[m
[32m+[m						[32m0.8F + world.random.nextFloat() * 0.2F);[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void maintainFuseEntities(ServerWorld world) {[m
[32m+[m		[32mactiveFuseEntities.entrySet().removeIf(entry -> {[m
[32m+[m			[32mEntity entity = world.getEntity(entry.getValue());[m
[32m+[m			[32mif (entity instanceof VirusFuseEntity fuse && fuse.isAlive()) {[m
[32m+[m				[32mreturn false;[m
[32m+[m			[32m}[m
[32m+[m			[32mTheVirusBlock.LOGGER.info("[Fuse] Removing dead fuse entity at {}", entry.getKey());[m
[32m+[m			[32mreturn true;[m
[32m+[m		[32m});[m
[32m+[m		[32mfor (BlockPos source : virusSources) {[m
[32m+[m			[32mif (!world.isChunkLoaded(ChunkPos.toLong(source))) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mclearBlockForFuse(world, source);[m
[32m+[m			[32mif (activeFuseEntities.containsKey(source)) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mVirusFuseEntity fuse = new VirusFuseEntity(world, source);[m
[32m+[m			[32mif (world.spawnEntity(fuse)) {[m
[32m+[m				[32mactiveFuseEntities.put(source.toImmutable(), fuse.getUuid());[m
[32m+[m				[32mTheVirusBlock.LOGGER.info("[Fuse] Spawned fuse entity at {}", source);[m
[32m+[m			[32m} else {[m
[32m+[m				[32mTheVirusBlock.LOGGER.warn("[Fuse] Failed to spawn fuse entity at {}", source);[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void maintainBlackholePearl(ServerWorld world) {[m
[32m+[m		[32mif (!ENABLE_BLACKHOLE_PEARL) {[m
[32m+[m			[32mclearBlackholePearl(world);[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityState == SingularityState.DORMANT || singularityCenter == null) {[m
[32m+[m			[32mclearBlackholePearl(world);[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (!world.isChunkLoaded(ChunkPos.toLong(singularityCenter))) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlackholePearlEntity pearl = getBlackholePearl(world);[m
[32m+[m		[32mif (pearl == null) {[m
[32m+[m			[32mpearl = BlackholePearlEntity.create(world, singularityCenter);[m
[32m+[m			[32mpearl.setTargetScale(getBlackholeTargetScale());[m
[32m+[m			[32mif (world.spawnEntity(pearl)) {[m
[32m+[m				[32mblackholePearlId = pearl.getUuid();[m
[32m+[m			[32m}[m
[32m+[m		[32m} else {[m
[32m+[m			[32mpearl.setAnchor(singularityCenter);[m
[32m+[m			[32mpearl.setTargetScale(getBlackholeTargetScale());[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate float getBlackholeTargetScale() {[m
[32m+[m		[32mreturn switch (singularityState) {[m
[32m+[m			[32mcase CORE, RING, DISSIPATION -> BLACKHOLE_CORE_SCALE;[m
[32m+[m			[32mdefault -> BLACKHOLE_PRIMARY_SCALE;[m
[32m+[m		[32m};[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void clearBlackholePearl(ServerWorld world) {[m
[32m+[m		[32mif (blackholePearlId == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mEntity entity = world.getEntity(blackholePearlId);[m
[32m+[m		[32mif (entity instanceof BlackholePearlEntity pearl) {[m
[32m+[m			[32mpearl.discard();[m
[32m+[m		[32m}[m
[32m+[m		[32mblackholePearlId = null;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32m@Nullable[m
[32m+[m	[32mprivate BlackholePearlEntity getBlackholePearl(ServerWorld world) {[m
[32m+[m		[32mif (blackholePearlId == null) {[m
[32m+[m			[32mreturn null;[m
[32m+[m		[32m}[m
[32m+[m		[32mEntity entity = world.getEntity(blackholePearlId);[m
[32m+[m		[32mif (entity instanceof BlackholePearlEntity pearl) {[m
[32m+[m			[32mreturn pearl;[m
[32m+[m		[32m}[m
[32m+[m		[32mblackholePearlId = null;[m
[32m+[m		[32mreturn null;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void installSingularityGlow(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mremoveSingularityGlow(world);[m
[32m+[m		[32mfor (BlockPos offset : SINGULARITY_GLOW_OFFSETS) {[m
[32m+[m			[32mBlockPos target = singularityCenter.add(offset);[m
[32m+[m			[32mif (!world.isChunkLoaded(ChunkPos.toLong(target))) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mBlockState state = world.getBlockState(target);[m
[32m+[m			[32mif (!state.isAir() && !state.isOf(Blocks.LIGHT)) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mBlockState light = Blocks.LIGHT.getDefaultState().with(LightBlock.LEVEL_15, 15);[m
[32m+[m			[32mworld.setBlockState(target, light, Block.NOTIFY_LISTENERS);[m
[32m+[m			[32msingularityGlowNodes.add(target.toImmutable());[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void removeSingularityGlow(ServerWorld world) {[m
[32m+[m		[32mif (singularityGlowNodes.isEmpty()) {[m
[32m+[m			[32mif (singularityCenter == null) {[m
[32m+[m				[32mreturn;[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32mfor (BlockPos pos : singularityGlowNodes) {[m
[32m+[m			[32mif (world.getBlockState(pos).isOf(Blocks.LIGHT)) {[m
[32m+[m				[32mworld.setBlockState(pos, Blocks.AIR.getDefaultState(), Block.NOTIFY_LISTENERS);[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32msingularityGlowNodes.clear();[m
[32m+[m		[32mif (singularityCenter != null) {[m
[32m+[m			[32mfor (BlockPos offset : SINGULARITY_GLOW_OFFSETS) {[m
[32m+[m				[32mBlockPos target = singularityCenter.add(offset);[m
[32m+[m				[32mif (world.getBlockState(target).isOf(Blocks.LIGHT)) {[m
[32m+[m					[32mworld.setBlockState(target, Blocks.AIR.getDefaultState(), Block.NOTIFY_LISTENERS);[m
[32m+[m				[32m}[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void clearBlockForFuse(ServerWorld world, BlockPos pos) {[m
[32m+[m		[32mif (fuseClearedBlocks.containsKey(pos)) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlockState state = world.getBlockState(pos);[m
[32m+[m		[32mif (!state.isOf(ModBlocks.VIRUS_BLOCK)) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32msuppressSourceUnregister(pos);[m
[32m+[m		[32mfuseClearedBlocks.put(pos.toImmutable(), state);[m
[32m+[m		[32mworld.setBlockState(pos, Blocks.AIR.getDefaultState(), Block.NOTIFY_LISTENERS | Block.SKIP_DROPS);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void restoreClearedFuseBlocks(ServerWorld world) {[m
[32m+[m		[32mif (fuseClearedBlocks.isEmpty()) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mIterator<Map.Entry<BlockPos, BlockState>> iterator = fuseClearedBlocks.entrySet().iterator();[m
[32m+[m		[32mwhile (iterator.hasNext()) {[m
[32m+[m			[32mMap.Entry<BlockPos, BlockState> entry = iterator.next();[m
[32m+[m			[32mBlockPos pos = entry.getKey();[m
[32m+[m			[32mif (!world.isChunkLoaded(ChunkPos.toLong(pos))) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mBlockState current = world.getBlockState(pos);[m
[32m+[m			[32mif (current.isAir()) {[m
[32m+[m				[32mworld.setBlockState(pos, entry.getValue(), Block.NOTIFY_LISTENERS);[m
[32m+[m			[32m}[m
[32m+[m			[32miterator.remove();[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mpublic boolean isFuseClearedBlock(BlockPos pos) {[m
[32m+[m		[32mreturn fuseClearedBlocks.containsKey(pos);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate boolean isVirusCoreBlock(BlockPos pos, BlockState state) {[m
[32m+[m		[32mreturn state.isOf(ModBlocks.VIRUS_BLOCK) || fuseClearedBlocks.containsKey(pos);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void suppressSourceUnregister(BlockPos pos) {[m
[32m+[m		[32msuppressedUnregisters.add(pos.toImmutable());[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mpublic boolean shouldSkipUnregister(BlockPos pos) {[m
[32m+[m		[32mreturn suppressedUnregisters.remove(pos);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void clearFuseEntities(ServerWorld world) {[m
[32m+[m		[32mclearFuseEntities(world, true);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void clearFuseEntities(ServerWorld world, boolean restoreBlocks) {[m
[32m+[m		[32mif (activeFuseEntities.isEmpty()) {[m
[32m+[m			[32mif (restoreBlocks) {[m
[32m+[m				[32mrestoreClearedFuseBlocks(world);[m
[32m+[m			[32m}[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mfor (UUID uuid : activeFuseEntities.values()) {[m
[32m+[m			[32mEntity entity = world.getEntity(uuid);[m
[32m+[m			[32mif (entity != null) {[m
[32m+[m				[32mentity.discard();[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32mactiveFuseEntities.clear();[m
[32m+[m		[32mif (restoreBlocks) {[m
[32m+[m			[32mrestoreClearedFuseBlocks(world);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate boolean isSingularitySuppressionActive() {[m
[32m+[m		[32mreturn singularityState == SingularityState.FUSING;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate boolean isSingularityActive() {[m
[32m+[m		[32mreturn singularityState != SingularityState.DORMANT;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate float getSingularitySuppressionProgress() {[m
[32m+[m		[32mif (!isSingularitySuppressionActive()) {[m
[32m+[m			[32mreturn 0.0F;[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn MathHelper.clamp(1.0F - (float) singularityTicks / (float) SINGULARITY_WARNING_TICKS, 0.0F, 1.0F);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate double getSingularityActivityMultiplier() {[m
[32m+[m		[32mif (!isSingularitySuppressionActive()) {[m
[32m+[m			[32mreturn 1.0D;[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn MathHelper.clamp(1.0D - getSingularitySuppressionProgress(), 0.0D, 1.0D);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate float getMatrixCubeSingularityFactor() {[m
[32m+[m		[32mreturn switch (singularityState) {[m
[32m+[m			[32mcase DORMANT -> 1.0F;[m
[32m+[m			[32mcase FUSING -> 0.35F;[m
[32m+[m			[32mdefault -> 0.0F;[m
[32m+[m		[32m};[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate boolean shouldSkipSpreadThisTick(ServerWorld world) {[m
[32m+[m		[32mfloat progress = getSingularitySuppressionProgress();[m
[32m+[m		[32mif (progress <= 0.0F) {[m
[32m+[m			[32mreturn false;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (progress >= 0.999F) {[m
[32m+[m			[32mreturn true;[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn world.random.nextFloat() < progress;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate int computeInitialCollapseRadius(ServerWorld world) {[m
[32m+[m		[32mint radius = SINGULARITY_COLLAPSE_MAX_RADIUS;[m
[32m+[m		[32mList<ServerPlayerEntity> players = world.getPlayers(PlayerEntity::isAlive);[m
[32m+[m		[32mif (!players.isEmpty()) {[m
[32m+[m			[32mdouble maxDistance = 0.0D;[m
[32m+[m			[32mBlockPos center = singularityCenter != null ? singularityCenter : players.get(0).getBlockPos();[m
[32m+[m			[32mfor (ServerPlayerEntity player : players) {[m
[32m+[m				[32mdouble distance = Math.max(player.squaredDistanceTo(Vec3d.ofCenter(center)), 0.0D);[m
[32m+[m				[32mmaxDistance = Math.max(maxDistance, Math.sqrt(distance));[m
[32m+[m			[32m}[m
[32m+[m			[32mradius = (int) Math.min(SINGULARITY_COLLAPSE_MAX_RADIUS, Math.max(32.0D, maxDistance + 32.0D));[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn Math.max(16, radius);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void tickSingularityBorder(ServerWorld world) {[m
[32m+[m		[32mif (!singularityBorderActive) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32msingularityBorderLastDiameter = world.getWorldBorder().getSize();[m
[32m+[m		[32mif (singularityBorderDuration > 0L) {[m
[32m+[m			[32msingularityBorderElapsed = Math.min(singularityBorderDuration, singularityBorderElapsed + 1);[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityTotalRingTicks > 0L) {[m
[32m+[m			[32msingularityRingTickAccumulator = Math.min(singularityTotalRingTicks, singularityRingTickAccumulator + 1);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void deploySingularityBorder(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null || singularityRingThresholds.isEmpty()) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mWorldBorder border = world.getWorldBorder();[m
[32m+[m		[32mcaptureOriginalBorder(border);[m
[32m+[m		[32mdouble centerX = singularityCenter.getX() + 0.5D;[m
[32m+[m		[32mdouble centerZ = singularityCenter.getZ() + 0.5D;[m
[32m+[m		[32mdouble outerRadius = singularityRingThresholds.getDouble(0);[m
[32m+[m		[32mdouble innerRadius = singularityRingThresholds.getDouble(singularityRingThresholds.size() - 1);[m
[32m+[m		[32mdouble initialDiameter = Math.max(SINGULARITY_BORDER_MIN_DIAMETER, outerRadius * 2.0D);[m
[32m+[m		[32mdouble finalDiameter = Math.max(SINGULARITY_BORDER_FINAL_DIAMETER, innerRadius * 2.0D);[m
[32m+[m		[32mborder.setCenter(centerX, centerZ);[m
[32m+[m		[32mborder.setSize(initialDiameter);[m
[32m+[m		[32msingularityBorderActive = true;[m
[32m+[m		[32msingularityBorderCenterX = centerX;[m
[32m+[m		[32msingularityBorderCenterZ = centerZ;[m
[32m+[m		[32msingularityBorderInitialDiameter = initialDiameter;[m
[32m+[m		[32msingularityBorderTargetDiameter = finalDiameter;[m
[32m+[m		[32msingularityBorderLastDiameter = initialDiameter;[m
[32m+[m		[32msingularityInitialBorderDiameter = initialDiameter;[m
[32m+[m		[32msingularityFinalBorderDiameter = finalDiameter;[m
[32m+[m		[32mint ringStages = Math.max(1, Math.max(singularityRingChunkCounts.size(), singularityRingThresholds.size()));[m
[32m+[m		[32msingularityTotalRingTicks = (long) ringStages * SINGULARITY_COLLAPSE_TICK_INTERVAL;[m
[32m+[m		[32mlong duration = Math.max(40L, singularityTotalRingTicks);[m
[32m+[m		[32msingularityBorderDuration = duration;[m
[32m+[m		[32msingularityBorderElapsed = 0L;[m
[32m+[m		[32msingularityRingTickAccumulator = 0L;[m
[32m+[m		[32msingularityRingIndex = -1;[m
[32m+[m		[32msingularityRingPendingChunks = 0;[m
[32m+[m		[32mmarkDirty();[m
[32m+[m		[32msyncSingularityBorder(world);[m
[32m+[m		[32mworld.getWorldBorder().interpolateSize(initialDiameter, finalDiameter, duration);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void restoreSingularityBorder(ServerWorld world) {[m
[32m+[m		[32mif (!singularityBorderActive && !singularityBorderHasSnapshot) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mWorldBorder border = world.getWorldBorder();[m
[32m+[m		[32mif (singularityBorderHasSnapshot) {[m
[32m+[m			[32mborder.setCenter(singularityBorderOriginalCenterX, singularityBorderOriginalCenterZ);[m
[32m+[m			[32mborder.setSize(singularityBorderOriginalDiameter);[m
[32m+[m			[32mborder.setSafeZone(singularityBorderOriginalSafeZone);[m
[32m+[m			[32mborder.setDamagePerBlock(singularityBorderOriginalDamagePerBlock);[m
[32m+[m			[32mborder.setWarningBlocks(singularityBorderOriginalWarningBlocks);[m
[32m+[m			[32mborder.setWarningTime(singularityBorderOriginalWarningTime);[m
[32m+[m		[32m}[m
[32m+[m		[32mclearSingularityBorderState();[m
[32m+[m		[32mmarkDirty();[m
[32m+[m		[32msyncSingularityBorder(world);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void syncSingularityBorder(ServerWorld world) {[m
[32m+[m		[32mif (world == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mdouble diameter = world.getWorldBorder().getSize();[m
[32m+[m		[32mdouble centerX = singularityBorderCenterX;[m
[32m+[m		[32mdouble centerZ = singularityBorderCenterZ;[m
[32m+[m		[32mif (centerX == 0.0D && singularityCenter != null) {[m
[32m+[m			[32mcenterX = singularityCenter.getX() + 0.5D;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (centerZ == 0.0D && singularityCenter != null) {[m
[32m+[m			[32mcenterZ = singularityCenter.getZ() + 0.5D;[m
[32m+[m		[32m}[m
[32m+[m		[32mSingularityBorderPayload payload = new SingularityBorderPayload([m
[32m+[m				[32msingularityBorderActive,[m
[32m+[m				[32mcenterX,[m
[32m+[m				[32mcenterZ,[m
[32m+[m				[32msingularityBorderInitialDiameter,[m
[32m+[m				[32mdiameter,[m
[32m+[m				[32msingularityBorderTargetDiameter,[m
[32m+[m				[32msingularityBorderDuration,[m
[32m+[m				[32msingularityBorderElapsed,[m
[32m+[m				[32msingularityState.name()[m
[32m+[m		[32m);[m
[32m+[m		[32mfor (ServerPlayerEntity player : world.getPlayers(PlayerEntity::isAlive)) {[m
[32m+[m			[32mServerPlayNetworking.send(player, payload);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void captureOriginalBorder(WorldBorder border) {[m
[32m+[m		[32mif (singularityBorderHasSnapshot) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32msingularityBorderOriginalCenterX = border.getCenterX();[m
[32m+[m		[32msingularityBorderOriginalCenterZ = border.getCenterZ();[m
[32m+[m		[32msingularityBorderOriginalDiameter = border.getSize();[m
[32m+[m		[32msingularityBorderOriginalSafeZone = border.getSafeZone();[m
[32m+[m		[32msingularityBorderOriginalDamagePerBlock = border.getDamagePerBlock();[m
[32m+[m		[32msingularityBorderOriginalWarningBlocks = border.getWarningBlocks();[m
[32m+[m		[32msingularityBorderOriginalWarningTime = border.getWarningTime();[m
[32m+[m		[32msingularityBorderHasSnapshot = true;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void clearSingularityBorderState() {[m
[32m+[m		[32msingularityBorderActive = false;[m
[32m+[m		[32msingularityBorderHasSnapshot = false;[m
[32m+[m		[32msingularityBorderCenterX = 0.0D;[m
[32m+[m		[32msingularityBorderCenterZ = 0.0D;[m
[32m+[m		[32msingularityBorderInitialDiameter = 0.0D;[m
[32m+[m		[32msingularityBorderTargetDiameter = 0.0D;[m
[32m+[m		[32msingularityBorderDuration = 0L;[m
[32m+[m		[32msingularityBorderElapsed = 0L;[m
[32m+[m		[32msingularityBorderLastDiameter = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalCenterX = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalCenterZ = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalDiameter = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalSafeZone = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalDamagePerBlock = 0.0D;[m
[32m+[m		[32msingularityBorderOriginalWarningBlocks = 0;[m
[32m+[m		[32msingularityBorderOriginalWarningTime = 0;[m
[32m+[m		[32msingularityRingThresholds.clear();[m
[32m+[m		[32msingularityRingChunkCounts.clear();[m
[32m+[m		[32msingularityRingIndex = -1;[m
[32m+[m		[32msingularityRingPendingChunks = 0;[m
[32m+[m		[32msingularityInitialBorderDiameter = 0.0D;[m
[32m+[m		[32msingularityFinalBorderDiameter = 0.0D;[m
[32m+[m		[32msingularityTotalRingTicks = 0L;[m
[32m+[m		[32msingularityRingTickAccumulator = 0L;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void activateSingularityBlock(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null || !world.isChunkLoaded(ChunkPos.toLong(singularityCenter))) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlockState state = world.getBlockState(singularityCenter);[m
[32m+[m		[32mif (!state.isOf(ModBlocks.SINGULARITY_BLOCK)) {[m
[32m+[m			[32mworld.setBlockState(singularityCenter, ModBlocks.SINGULARITY_BLOCK.getDefaultState(), Block.NOTIFY_ALL);[m
[32m+[m		[32m}[m
[32m+[m		[32minstallSingularityGlow(world);[m
[32m+[m		[32mfuseClearedBlocks.remove(singularityCenter);[m
[32m+[m		[32mBlockEntity blockEntity = world.getBlockEntity(singularityCenter);[m
[32m+[m		[32mif (blockEntity instanceof SingularityBlockEntity singularityBlock) {[m
[32m+[m			[32msingularityBlock.startSequence(world);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void detonateFuseCore(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mVec3d fusePos = resolveFusePosition(world, singularityCenter);[m
[32m+[m		[32mBlockPos elevatedCenter = BlockPos.ofFloored(fusePos);[m
[32m+[m		[32mif (!elevatedCenter.equals(singularityCenter)) {[m
[32m+[m			[32msingularityCenter = elevatedCenter;[m
[32m+[m		[32m}[m
[32m+[m		[32mworld.playSound(null,[m
[32m+[m				[32mfusePos.x,[m
[32m+[m				[32mfusePos.y,[m
[32m+[m				[32mfusePos.z,[m
[32m+[m				[32mSoundEvents.ENTITY_GENERIC_EXPLODE,[m
[32m+[m				[32mSoundCategory.BLOCKS,[m
[32m+[m				[32m4.0F,[m
[32m+[m				[32m0.6F);[m
[32m+[m		[32mworld.spawnParticles(ParticleTypes.EXPLOSION_EMITTER,[m
[32m+[m				[32mfusePos.x,[m
[32m+[m				[32mfusePos.y,[m
[32m+[m				[32mfusePos.z,[m
[32m+[m				[32m2,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.01D);[m
[32m+[m		[32mpushPlayersFromBlock(world, singularityCenter, FINAL_VULNERABILITY_BLAST_RADIUS, FINAL_VULNERABILITY_BLAST_SCALE, false);[m
[32m+[m		[32mworld.syncWorldEvent(WorldEvents.BLOCK_BROKEN, singularityCenter, Block.getRawIdFromState(ModBlocks.VIRUS_BLOCK.getDefaultState()));[m
[32m+[m		[32mclearFuseEntities(world, false);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate Vec3d resolveFusePosition(ServerWorld world, BlockPos source) {[m
[32m+[m		[32mUUID fuseId = activeFuseEntities.get(source);[m
[32m+[m		[32mif (fuseId != null) {[m
[32m+[m			[32mEntity entity = world.getEntity(fuseId);[m
[32m+[m			[32mif (entity instanceof VirusFuseEntity fuse) {[m
[32m+[m				[32mreturn fuse.getPos();[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn Vec3d.ofCenter(source);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void ensureSingularityCenter(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter != null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlockPos candidate = representativePos(world, world.getRandom());[m
[32m+[m		[32mif (candidate == null && !virusSources.isEmpty()) {[m
[32m+[m			[32mcandidate = virusSources.iterator().next();[m
[32m+[m		[32m}[m
[32m+[m		[32mif (candidate == null) {[m
[32m+[m			[32mcandidate = world.getSpawnPos();[m
[32m+[m		[32m}[m
[32m+[m		[32mif (candidate != null) {[m
[32m+[m			[32msingularityCenter = candidate.toImmutable();[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void revertSingularityBlock(ServerWorld world, boolean remove) {[m
[32m+[m		[32mif (singularityCenter == null || !world.isChunkLoaded(ChunkPos.toLong(singularityCenter))) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlockState state = world.getBlockState(singularityCenter);[m
[32m+[m		[32mif (!state.isOf(ModBlocks.SINGULARITY_BLOCK)) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mBlockState replacement = remove ? Blocks.AIR.getDefaultState() : ModBlocks.VIRUS_BLOCK.getDefaultState();[m
[32m+[m		[32mworld.setBlockState(singularityCenter, replacement, Block.NOTIFY_LISTENERS);[m
[32m+[m		[32mSingularityBlockEntity.notifyStop(world, singularityCenter);[m
[32m+[m		[32mworld.getChunkManager().markForUpdate(singularityCenter);[m
[32m+[m		[32mremoveSingularityGlow(world);[m
[32m+[m		[32mfuseClearedBlocks.remove(singularityCenter);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void prepareSingularityChunkQueue(ServerWorld world) {[m
[32m+[m		[32msingularityChunkQueue.clear();[m
[32m+[m		[32msingularityCollapseTotalChunks = 0;[m
[32m+[m		[32msingularityCollapseCompletedChunks = 0;[m
[32m+[m		[32msingularityRingThresholds.clear();[m
[32m+[m		[32msingularityRingChunkCounts.clear();[m
[32m+[m		[32msingularityRingIndex = -1;[m
[32m+[m		[32msingularityRingPendingChunks = 0;[m
[32m+[m		[32msingularityInitialBorderDiameter = 0.0D;[m
[32m+[m		[32msingularityFinalBorderDiameter = 0.0D;[m
[32m+[m		[32msingularityTotalRingTicks = 0L;[m
[32m+[m		[32msingularityRingTickAccumulator = 0L;[m
[32m+[m		[32mensureSingularityCenter(world);[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mTheVirusBlock.LOGGER.warn("[Singularity] Unable to prepare collapse queue because center is null");[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mChunkPos centerChunk = new ChunkPos(singularityCenter);[m
[32m+[m		[32mint maxRadiusInChunks = Math.max(1, MathHelper.ceil(SINGULARITY_COLLAPSE_MAX_RADIUS / 16.0F));[m
[32m+[m		[32mLongSet seen = new LongOpenHashSet();[m
[32m+[m		[32mfor (int radius = maxRadiusInChunks; radius >= 0; radius--) {[m
[32m+[m			[32mint before = singularityChunkQueue.size();[m
[32m+[m			[32mappendChunkRing(centerChunk, radius, seen);[m
[32m+[m			[32mint added = singularityChunkQueue.size() - before;[m
[32m+[m			[32mif (added > 0) {[m
[32m+[m				[32mdouble threshold = computeRingThreshold(radius);[m
[32m+[m				[32msingularityRingThresholds.add(threshold);[m
[32m+[m				[32msingularityRingChunkCounts.add(added);[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityChunkQueue.isEmpty()) {[m
[32m+[m			[32mlong packed = centerChunk.toLong();[m
[32m+[m			[32msingularityChunkQueue.addLast(packed);[m
[32m+[m			[32msingularityRingThresholds.add(computeRingThreshold(0));[m
[32m+[m			[32msingularityRingChunkCounts.add(1);[m
[32m+[m		[32m}[m
[32m+[m		[32mdouble finalThreshold = Math.max(SINGULARITY_BORDER_FINAL_DIAMETER * 0.5D, 0.0D);[m
[32m+[m		[32msingularityRingThresholds.add(finalThreshold);[m
[32m+[m		[32msingularityRingChunkCounts.add(0);[m
[32m+[m		[32msingularityCollapseTotalChunks = Math.max(1, singularityChunkQueue.size());[m
[32m+[m		[32msingularityCollapseCompletedChunks = 0;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void appendChunkRing(ChunkPos center, int radius, LongSet seen) {[m
[32m+[m		[32mif (radius == 0) {[m
[32m+[m			[32maddChunkToQueue(center.x, center.z, seen);[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mint minX = center.x - radius;[m
[32m+[m		[32mint maxX = center.x + radius;[m
[32m+[m		[32mint minZ = center.z - radius;[m
[32m+[m		[32mint maxZ = center.z + radius;[m
[32m+[m		[32mfor (int x = minX; x <= maxX; x++) {[m
[32m+[m			[32maddChunkToQueue(x, minZ, seen);[m
[32m+[m			[32maddChunkToQueue(x, maxZ, seen);[m
[32m+[m		[32m}[m
[32m+[m		[32mfor (int z = minZ + 1; z <= maxZ - 1; z++) {[m
[32m+[m			[32maddChunkToQueue(minX, z, seen);[m
[32m+[m			[32maddChunkToQueue(maxX, z, seen);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void addChunkToQueue(int chunkX, int chunkZ, LongSet seen) {[m
[32m+[m		[32mChunkPos pos = new ChunkPos(chunkX, chunkZ);[m
[32m+[m		[32mlong packed = pos.toLong();[m
[32m+[m		[32mif (seen.add(packed)) {[m
[32m+[m			[32msingularityChunkQueue.addLast(packed);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate double computeRingThreshold(int chunkRadius) {[m
[32m+[m		[32mdouble blockRadius = (chunkRadius + 1) * 16.0D;[m
[32m+[m		[32mreturn blockRadius + SINGULARITY_BORDER_OVERSTEP;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate List<Double> copyRingThresholds() {[m
[32m+[m		[32mList<Double> list = new ArrayList<>(singularityRingThresholds.size());[m
[32m+[m		[32mfor (double value : singularityRingThresholds) {[m
[32m+[m			[32mlist.add(value);[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn list;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate List<Integer> copyRingCounts() {[m
[32m+[m		[32mList<Integer> list = new ArrayList<>(singularityRingChunkCounts.size());[m
[32m+[m		[32mfor (int value : singularityRingChunkCounts) {[m
[32m+[m			[32mlist.add(value);[m
[32m+[m		[32m}[m
[32m+[m		[32mreturn list;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void tickCollapseBarDelay() {[m
[32m+[m		[32mif (singularityCollapseBarDelay >= 0) {[m
[32m+[m			[32msingularityCollapseBarDelay--;[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void processSingularityCollapse(ServerWorld world) {[m
[32m+[m		[32mtickCollapseBarDelay();[m
[32m+[m		[32mensureSingularityCenter(world);[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityChunkQueue.isEmpty() && singularityRingPendingChunks <= 0 && singularityRingIndex >= singularityRingThresholds.size() - 1) {[m
[32m+[m			[32mif (singularityCollapseBarDelay <= 0) {[m
[32m+[m				[32mif (singularityCollapseCompleteHold > 0) {[m
[32m+[m					[32msingularityCollapseCompleteHold--;[m
[32m+[m					[32mreturn;[m
[32m+[m				[32m}[m
[32m+[m				[32mif (singularityCollapseCompletedChunks >= singularityCollapseTotalChunks) {[m
[32m+[m					[32msingularityState = SingularityState.CORE;[m
[32m+[m					[32msingularityRingTicks = SINGULARITY_RING_DURATION;[m
[32m+[m					[32msingularityPhaseDelay = SINGULARITY_CORE_CHARGE_TICKS;[m
[32m+[m					[32mbroadcast(world, Text.translatable("message.the-virus-block.singularity_core").formatted(Formatting.RED));[m
[32m+[m					[32msyncSingularityBorder(world);[m
[32m+[m					[32mmarkDirty();[m
[32m+[m				[32m}[m
[32m+[m			[32m}[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32madvanceRingIndexIfNeeded(world);[m
[32m+[m		[32mif (singularityRingPendingChunks <= 0) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityCollapseTickCooldown > 0) {[m
[32m+[m			[32msingularityCollapseTickCooldown--;[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mint processed = 0;[m
[32m+[m		[32mwhile (processed < SINGULARITY_COLLAPSE_CHUNKS_PER_STEP[m
[32m+[m				[32m&& singularityRingPendingChunks > 0[m
[32m+[m				[32m&& !singularityChunkQueue.isEmpty()) {[m
[32m+[m			[32mlong chunk = singularityChunkQueue.pollFirst();[m
[32m+[m			[32mif (!collapseChunk(world, chunk, singularityCollapseDescending)) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mif (singularityCollapseCompletedChunks < singularityCollapseTotalChunks) {[m
[32m+[m				[32msingularityCollapseCompletedChunks++;[m
[32m+[m			[32m}[m
[32m+[m			[32msingularityCollapseDescending = !singularityCollapseDescending;[m
[32m+[m			[32mupdateCollapseRadiusFromChunk(chunk);[m
[32m+[m			[32msingularityRingPendingChunks--;[m
[32m+[m			[32mprocessed++;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityChunkQueue.isEmpty()) {[m
[32m+[m			[32msingularityCollapseRadius = 0;[m
[32m+[m			[32msingularityCollapseCompletedChunks = Math.min(singularityCollapseCompletedChunks, singularityCollapseTotalChunks);[m
[32m+[m		[32m}[m
[32m+[m		[32msingularityCollapseTickCooldown = processed > 0 ? SINGULARITY_COLLAPSE_TICK_INTERVAL : 0;[m
[32m+[m		[32mmarkDirty();[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate boolean collapseChunk(ServerWorld world, long chunkLong, boolean fromBottom) {[m
[32m+[m		[32mif (!world.isChunkLoaded(chunkLong)) {[m
[32m+[m			[32msingularityChunkQueue.addLast(chunkLong);[m
[32m+[m			[32mreturn false;[m
[32m+[m		[32m}[m
[32m+[m		[32mChunkPos chunk = new ChunkPos(chunkLong);[m
[32m+[m		[32mint minY = world.getBottomY();[m
[32m+[m		[32mint maxY = world.getBottomY() + world.getDimension().height() - 1;[m
[32m+[m		[32mint startY = fromBottom ? minY : maxY;[m
[32m+[m		[32mint endY = fromBottom ? maxY : minY;[m
[32m+[m		[32mint step = fromBottom ? 1 : -1;[m
[32m+[m		[32mMutable pos = new Mutable();[m
[32m+[m		[32mfor (int x = chunk.getStartX(); x <= chunk.getEndX(); x++) {[m
[32m+[m			[32mfor (int z = chunk.getStartZ(); z <= chunk.getEndZ(); z++) {[m
[32m+[m				[32mpos.set(x, startY, z);[m
[32m+[m				[32mfor (int y = startY; step > 0 ? y <= endY : y >= endY; y += step) {[m
[32m+[m					[32mpos.setY(y);[m
[32m+[m					[32mBlockState state = world.getBlockState(pos);[m
[32m+[m					[32mif (state.isAir()[m
[32m+[m							[32m|| state.isOf(ModBlocks.VIRUS_BLOCK)[m
[32m+[m							[32m|| state.isOf(ModBlocks.SINGULARITY_BLOCK)[m
[32m+[m							[32m|| state.getHardness(world, pos) < 0.0F) {[m
[32m+[m						[32mcontinue;[m
[32m+[m					[32m}[m
[32m+[m					[32mworld.setBlockState(pos, Blocks.AIR.getDefaultState(), Block.NOTIFY_LISTENERS);[m
[32m+[m					[32mspawnCollapseParticles(world, pos);[m
[32m+[m				[32m}[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m		[32mspawnChunkVeil(world, chunk);[m
[32m+[m		[32mreturn true;[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void spawnChunkVeil(ServerWorld world, ChunkPos chunk) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mdouble centerX = chunk.getCenterX();[m
[32m+[m		[32mdouble centerZ = chunk.getCenterZ();[m
[32m+[m		[32mdouble centerY = singularityCenter.getY() + world.random.nextGaussian() * 2.0D;[m
[32m+[m		[32mfor (int i = 0; i < 8; i++) {[m
[32m+[m			[32mdouble angle = (Math.PI * 2 * i) / 8.0D + world.random.nextDouble() * 0.15D;[m
[32m+[m			[32mdouble radius = 8.0D + world.random.nextDouble() * 4.0D;[m
[32m+[m			[32mdouble x = centerX + Math.cos(angle) * radius;[m
[32m+[m			[32mdouble z = centerZ + Math.sin(angle) * radius;[m
[32m+[m			[32mdouble y = centerY + world.random.nextGaussian() * 1.5D;[m
[32m+[m			[32mworld.spawnParticles(ParticleTypes.SCULK_SOUL, x, y, z, 3, 0.2D, 0.2D, 0.2D, 0.01D);[m
[32m+[m			[32mworld.spawnParticles(ParticleTypes.REVERSE_PORTAL, x, y + 0.8D, z, 2, 0.05D, 0.1D, 0.05D, 0.05D);[m
[32m+[m		[32m}[m
[32m+[m		[32mworld.playSound(null,[m
[32m+[m				[32mcenterX,[m
[32m+[m				[32mcenterY,[m
[32m+[m				[32mcenterZ,[m
[32m+[m				[32mSoundEvents.ENTITY_WARDEN_SONIC_BOOM,[m
[32m+[m				[32mSoundCategory.HOSTILE,[m
[32m+[m				[32m1.2F,[m
[32m+[m				[32m0.6F + world.random.nextFloat() * 0.3F);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void updateCollapseRadiusFromChunk(long chunkLong) {[m
[32m+[m		[32msingularityCollapseRadius = (int) Math.max(0.0D, Math.round(chunkDistanceFromCenter(chunkLong)));[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate double chunkDistanceFromCenter(long chunkLong) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn 0.0D;[m
[32m+[m		[32m}[m
[32m+[m		[32mChunkPos center = new ChunkPos(singularityCenter);[m
[32m+[m		[32mChunkPos current = new ChunkPos(chunkLong);[m
[32m+[m		[32mdouble dx = (current.x - center.x) * 16.0D;[m
[32m+[m		[32mdouble dz = (current.z - center.z) * 16.0D;[m
[32m+[m		[32mreturn Math.sqrt(dx * dx + dz * dz);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void collapseColumn(ServerWorld world, BlockPos target, int startY, int endY, int step) {[m
[32m+[m		[32mlong chunkLong = ChunkPos.toLong(target);[m
[32m+[m		[32mif (!world.isChunkLoaded(chunkLong)) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mMutable pos = new Mutable(target.getX(), startY, target.getZ());[m
[32m+[m		[32mfor (int y = startY; step > 0 ? y <= endY : y >= endY; y += step) {[m
[32m+[m			[32mpos.setY(y);[m
[32m+[m			[32mBlockState state = world.getBlockState(pos);[m
[32m+[m			[32mif (state.isAir() || state.isOf(ModBlocks.VIRUS_BLOCK) || state.isOf(ModBlocks.SINGULARITY_BLOCK)) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mif (state.getHardness(world, pos) < 0.0F) {[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}[m
[32m+[m			[32mworld.setBlockState(pos, Blocks.AIR.getDefaultState(), Block.NOTIFY_LISTENERS);[m
[32m+[m			[32mspawnCollapseParticles(world, pos);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void spawnCollapseParticles(ServerWorld world, BlockPos pos) {[m
[32m+[m		[32mworld.spawnParticles([m
[32m+[m				[32mParticleTypes.ASH,[m
[32m+[m				[32mpos.getX() + 0.5D,[m
[32m+[m				[32mpos.getY() + 0.5D,[m
[32m+[m				[32mpos.getZ() + 0.5D,[m
[32m+[m				[32mSINGULARITY_COLLAPSE_PARTICLE_DENSITY,[m
[32m+[m				[32m0.25D,[m
[32m+[m				[32m0.25D,[m
[32m+[m				[32m0.25D,[m
[32m+[m				[32m0.01D);[m
[32m+[m		[32mif (world.random.nextInt(20) == 0) {[m
[32m+[m			[32mworld.playSound(null, pos, SoundEvents.BLOCK_SCULK_SPREAD, SoundCategory.HOSTILE, 0.8F, 0.4F + world.random.nextFloat() * 0.2F);[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void advanceRingIndexIfNeeded(ServerWorld world) {[m
[32m+[m		[32mif (!singularityBorderActive || singularityRingThresholds.isEmpty()) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mdouble currentRadius = world.getWorldBorder().getSize() * 0.5D;[m
[32m+[m		[32mwhile (singularityRingIndex + 1 < singularityRingThresholds.size()[m
[32m+[m				[32m&& currentRadius <= singularityRingThresholds.getDouble(singularityRingIndex + 1)) {[m
[32m+[m			[32msingularityRingIndex++;[m
[32m+[m			[32mif (singularityRingIndex < singularityRingChunkCounts.size()) {[m
[32m+[m				[32msingularityRingPendingChunks += singularityRingChunkCounts.getInt(singularityRingIndex);[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void processSingularityCore(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityPhaseDelay > 0) {[m
[32m+[m			[32msingularityPhaseDelay--;[m
[32m+[m			[32mworld.spawnParticles(ParticleTypes.ENCHANT,[m
[32m+[m					[32msingularityCenter.getX() + 0.5D,[m
[32m+[m					[32msingularityCenter.getY() + 0.5D,[m
[32m+[m					[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m					[32m6,[m
[32m+[m					[32m0.3D,[m
[32m+[m					[32m0.3D,[m
[32m+[m					[32m0.3D,[m
[32m+[m					[32m0.02D);[m
[32m+[m			[32mif (singularityPhaseDelay % 10 == 0) {[m
[32m+[m				[32mworld.playSound(null,[m
[32m+[m						[32msingularityCenter.getX() + 0.5D,[m
[32m+[m						[32msingularityCenter.getY() + 0.5D,[m
[32m+[m						[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m						[32mSoundEvents.BLOCK_BEACON_AMBIENT,[m
[32m+[m						[32mSoundCategory.HOSTILE,[m
[32m+[m						[32m1.5F,[m
[32m+[m						[32m0.6F);[m
[32m+[m			[32m}[m
[32m+[m			[32mmarkDirty();[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mworld.playSound(null, singularityCenter, SoundEvents.ENTITY_WITHER_SPAWN, SoundCategory.HOSTILE, 4.0F, 0.5F);[m
[32m+[m		[32mworld.spawnParticles(ParticleTypes.EXPLOSION_EMITTER,[m
[32m+[m				[32msingularityCenter.getX() + 0.5D,[m
[32m+[m				[32msingularityCenter.getY() + 0.5D,[m
[32m+[m				[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m				[32m2,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.2D,[m
[32m+[m				[32m0.01D);[m
[32m+[m		[32mpushPlayersFromBlock(world, singularityCenter, 12, 2.0D, false);[m
[32m+[m		[32mworld.createExplosion(null, null, null, singularityCenter.getX() + 0.5D, singularityCenter.getY() + 0.5D, singularityCenter.getZ() + 0.5D, 10.0F, false, ExplosionSourceType.TNT);[m
[32m+[m		[32msingularityState = SingularityState.RING;[m
[32m+[m		[32msingularityPhaseDelay = SINGULARITY_RING_START_DELAY;[m
[32m+[m		[32msyncSingularityBorder(world);[m
[32m+[m		[32mmarkDirty();[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void processSingularityRing(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32msingularityState = SingularityState.DISSIPATION;[m
[32m+[m			[32msyncSingularityBorder(world);[m
[32m+[m			[32mmarkDirty();[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityPhaseDelay > 0) {[m
[32m+[m			[32msingularityPhaseDelay--;[m
[32m+[m			[32mworld.spawnParticles(ParticleTypes.SMALL_FLAME,[m
[32m+[m					[32msingularityCenter.getX() + 0.5D,[m
[32m+[m					[32msingularityCenter.getY() + 0.5D,[m
[32m+[m					[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m					[32m4,[m
[32m+[m					[32m0.2D,[m
[32m+[m					[32m0.2D,[m
[32m+[m					[32m0.2D,[m
[32m+[m					[32m0.01D);[m
[32m+[m			[32mmarkDirty();[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityRingTicks <= 0) {[m
[32m+[m			[32msingularityState = SingularityState.DISSIPATION;[m
[32m+[m			[32msingularityPhaseDelay = SINGULARITY_RESET_DELAY_TICKS;[m
[32m+[m			[32msyncSingularityBorder(world);[m
[32m+[m			[32mmarkDirty();[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32msingularityRingTicks--;[m
[32m+[m		[32mdouble radius = 8.0D + (SINGULARITY_RING_DURATION - singularityRingTicks) * 0.25D;[m
[32m+[m		[32mint segments = 48;[m
[32m+[m		[32mfor (int i = 0; i < segments; i++) {[m
[32m+[m			[32mdouble angle = (Math.PI * 2 * i) / segments;[m
[32m+[m			[32mdouble x = singularityCenter.getX() + 0.5D + Math.cos(angle) * radius;[m
[32m+[m			[32mdouble z = singularityCenter.getZ() + 0.5D + Math.sin(angle) * radius;[m
[32m+[m			[32mdouble y = singularityCenter.getY() + Math.sin(world.random.nextDouble() * Math.PI) * 2.0D;[m
[32m+[m			[32mworld.spawnParticles(ParticleTypes.PORTAL, x, y, z, 1, 0.0D, 0.0D, 0.0D, 0.0D);[m
[32m+[m			[32mBlockStateParticleEffect debris = new BlockStateParticleEffect(ParticleTypes.BLOCK, Blocks.DEEPSLATE.getDefaultState());[m
[32m+[m			[32mworld.spawnParticles(debris, x, y + 1.5D, z, 1, 0.0D, 0.1D, 0.0D, 0.02D);[m
[32m+[m		[32m}[m
[32m+[m		[32mfor (int i = 0; i < SINGULARITY_RING_COLUMNS_PER_TICK; i++) {[m
[32m+[m			[32mdouble angle = world.random.nextDouble() * Math.PI * 2;[m
[32m+[m			[32mdouble columnRadius = radius + world.random.nextBetween(-2, 2);[m
[32m+[m			[32mdouble x = singularityCenter.getX() + 0.5D + Math.cos(angle) * columnRadius;[m
[32m+[m			[32mdouble z = singularityCenter.getZ() + 0.5D + Math.sin(angle) * columnRadius;[m
[32m+[m			[32mBlockPos destroy = BlockPos.ofFloored(x, singularityCenter.getY(), z);[m
[32m+[m			[32mint minY = world.getBottomY();[m
[32m+[m			[32mint maxY = world.getBottomY() + world.getDimension().height() - 1;[m
[32m+[m			[32mboolean fromBottom = world.random.nextBoolean();[m
[32m+[m			[32mcollapseColumn(world, destroy, fromBottom ? minY : maxY, fromBottom ? maxY : minY, fromBottom ? 1 : -1);[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityRingTicks % 20 == 0) {[m
[32m+[m			[32mworld.playSound(null,[m
[32m+[m					[32msingularityCenter.getX() + 0.5D,[m
[32m+[m					[32msingularityCenter.getY() + 0.5D,[m
[32m+[m					[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m					[32mSoundEvents.AMBIENT_NETHER_WASTES_MOOD.value(),[m
[32m+[m					[32mSoundCategory.AMBIENT);[m
[32m+[m		[32m}[m
[32m+[m		[32mif (singularityRingTicks % 10 == 0) {[m
[32m+[m			[32mworld.playSound(null,[m
[32m+[m					[32msingularityCenter.getX() + 0.5D,[m
[32m+[m					[32msingularityCenter.getY() + 0.5D,[m
[32m+[m					[32msingularityCenter.getZ() + 0.5D,[m
[32m+[m					[32mSoundEvents.BLOCK_END_PORTAL_SPAWN,[m
[32m+[m					[32mSoundCategory.HOSTILE,[m
[32m+[m					[32m1.1F,[m
[32m+[m					[32m0.5F + world.random.nextFloat() * 0.2F);[m
[32m+[m		[32m}[m
[32m+[m		[32mpullEntitiesTowardRing(world, radius + SINGULARITY_RING_PULL_RADIUS);[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32mprivate void processSingularityDissipation(ServerWorld world) {[m
[32m+[m		[32mif (singularityCenter == null) {[m
[32m+[m			[32mclearFuseEntities(world);[m
[32m+[m			[32mresetSingularityState(world);[m
[32m+[m			[32mmarkDirty();[m
[32m+[m			[32mreturn;[m
[32m+[m		[32m}[m
[32m+[m		[32mworld.spawnParticles(ParticleTypes.REVERSE_PORTAL,[m
[32m+[m				[32msingularityCenter.getX() + 0.5D,[m
[32m+[m				[32msingularityCenter.getY() + 0.5D,[m
[32m+